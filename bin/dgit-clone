#!/bin/env bash

#
# clone git repo with associated work tree
#
Syntax()
{
  echo "Syntax:
  dgit-clone [<option>]* <url> <work-tree>
Where:
  <option> may be one of:
  -h|--help: this help
  -g|--separate-git-dir <directory> : git directory to clone into
  " >&2
  exit 4
}

# read the options
TEMP=`getopt -n dgit-init -o hg: --long help,separate-git-dir: -- "$@"`
eval set -- "$TEMP"

gitdir=''
worktree=''
while true; do
  case "$1" in
    -g|--separate-git-dir)
      gitdir=$2
      shift 2
      ;;
    -h|--help)
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "Internal Error!"
      exit 8
      ;;
  esac
done

if [ $# -ne 3 ]; then
  echo "URL and work-tree need to both be specified" >&2
  Syntax
fi

# git clone --separate-git-dir <git dir> <url> <work-tree>
cloneurl="$2"
worktree="$3"
branch=$(git config --get init.defaultbranch)
if [ -z "${branch}" ]; then
  branch='main'
fi
if ! mkdir "${gitdir}" ; then
  echo "Directory ${gitdir} already exists. Clone would overwrite - stopping." >&2
  exit 8
fi
if ! [ -d "${worktree}" ]; then
  echo "Work tree is expected to exist already. dgit-clone stopping." >&2
  exit 8
fi

if ! dgit-init --git-dir="${gitdir}" --work-tree="${worktree}" ; then
  echo "Unable to initialize git directory and work tree" >&2
  exit 8
fi

if ! cd "${gitdir}" || ! git remote add "origin/${branch}" "${cloneurl}" ; then 
  echo "Unable to establish remote to origin/${branch} ${cloneurl}" >&2
  exit 8
fi
echo "Attempt to merge clone and local tree"
if ! git push -u origin "${branch}" ; then
  echo "Unable to push changes to ${cloneurl}" >&2
  exit 4
fi

git pull origin "${branch}"
