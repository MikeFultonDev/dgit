#!/bin/env bash

#
# add dataset to git-managed list. 
# Add an explicit entry for the file to exclude if from the 'ignore' list
# and then perform a standard 'git add'
#
Syntax()
{
  echo "Syntax:
  [<option>]* <verb> [<parameters>]*
Where:
  <options may be one of:>
  -h|--help: this help
  " >&2
  exit 4
}

# read the options
TEMP=`getopt -n dgit-add -o h --long help -- "$@"`
eval set -- "$TEMP"

gitdir=''
worktree=''
while true; do
  case "$1" in
    -h|--help)
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "Internal Error!"
      exit 8
      ;;
  esac
done

set -x
if gitdir=$(git rev-parse --git-dir) ; then
  exclude="${gitdir}/info/exclude"
  if [ -f "${exclude}" ]; then 
    echo "found exclude file"
  else
    echo "unable to find exclude file" >&2
  fi
else
  echo "unable to find .git directory" >&2
fi

if worktree=$(git config --get core.worktree) ; then
  if ! grep -e "^\!${2}\$" "${worktree}/GITEXCL" ; then
    if ! echo "!${2}" >> "${worktree}/GITEXCL" ; then
      echo "Unable to add !${2} to ${worktree}/GITEXCL" >&2
      exit 8
    fi
  else
    echo "File ${2} already in GITEXCL - GITEXCL not changed"
  fi
fi
git "$@"
