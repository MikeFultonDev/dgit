#!/bin/env bash

#
# initialize a git repo with a corresponding separate working tree
#
Syntax()
{
  echo "Syntax:
  dgit --git-dir <git-directory> --work-tree <work-tree> init
Where:
  <options may be one of:>
  -h|--help: this help
  " >&2
  exit 4
}

# read the options
TEMP=`getopt -n dgit-init -o hg:w: --long help,git-dir:,work-tree: -- "$@"`
eval set -- "$TEMP"

gitdir=''
worktree=''
while true; do
  case "$1" in
    -g|--git-dir)
      gitdir=$2
      shift 2
      ;;
    -w|--work-tree)
      worktree=$2
      shift 2
      ;;
    -h|--help)
      shift
      ;;
    --) 
      shift
      break
      ;;
    *) 
      echo "Internal Error!"
      exit 8
      ;;
  esac
done

if [ -z "${gitdir}" ] || [ -z "${worktree}" ]; then
  Syntax
fi

if ! git --git-dir "${gitdir}" --work-tree "${worktree}" "init" ;then
  exit 8
fi

dataset=''
if [ "${worktree##/dsfs/}" != "${worktree}" ]; then
  # We are dealing with a dataset-mapped directory
  if [ "${worktree##/dsfs/txt/}" = "${worktree}" ]; then
    # Only support for 'txt' so fail
    echo "dgit only supports a work-tree under /dsfs/txt" >&2
    exit 8
  else
    dataset=$(echo "${worktree##/dsfs/txt/}" | tr '/' '.')
  fi
fi

gitattr="${worktree}/gitattr"
if ! [ -f "${gitattr}" ]; then
  if [ "${dataset}x" != "x" ] ; then
    if ! dtouch -tseq "${dataset}.gitattr" ; then
      echo "Unable to allocate ${dataset} for dgit initialization" >&2
      exit 8
    fi
  fi
  if ! /bin/echo "# Attributes to use for files (EBCDIC CCSID 1047 by default)
text zos-working-tree-encoding=IBM-1047" >"${gitattr}" ; then
    echo "Unable to create attributes file in ${gitattr}. Need write access" >&2
    exit 4
  fi
fi

if ! ln -s "${gitattr}" "${gitdir}/info/attributes" ; then
  echo "Unable to create link to ${gitattr} from ${gitdir}/info/attributes" >&2
  exit 4
fi

